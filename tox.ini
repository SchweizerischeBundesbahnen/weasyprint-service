[tox]
envlist =
    lint
    py314

[testenv:lint]
description = run linters and formatters
runner = uv-venv-lock-runner
package = skip
dependency_groups = dev
setenv =
    # Store Playwright browsers inside .tox for better caching
    PLAYWRIGHT_BROWSERS_PATH = {toxworkdir}/.playwright
commands =
    ruff format
    ruff check
    mypy .

[testenv]
description = run pytest and coverage
runner = uv-venv-lock-runner
package = skip
dependency_groups =
    dev
    test
setenv =
    # Store Playwright browsers inside .tox for better caching
    PLAYWRIGHT_BROWSERS_PATH = {toxworkdir}/.playwright
    # macOS: Set library path for WeasyPrint system dependencies
    DYLD_LIBRARY_PATH = /opt/homebrew/lib:{env:DYLD_LIBRARY_PATH:}
commands_pre =
    # Playwright is required for browser-based tests; ensure Chromium is installed before running tests.
    playwright install chromium --with-deps
commands =
    coverage run -m pytest tests/ --junitxml="junittest.xml" -v
    coverage report -m --fail-under 90
    coverage xml

[coverage:run]
relative_files = True
source = app/
branch = True
